# Andastra.NET Rules for AI Agents

(2025 Edition – Optimized for LLM Performance & Compliance)

## 1. CRITICAL: ALWAYS COMMIT EVERY CHANGE

Commit format: Conventional Commits
`fix:`, `feat:`, `refactor:`, `docs:`, `chore:`, `test:`

**Rule #1 – Non-negotiable**
After ANY file change (create, modify, delete, move):

### Windows

```powershell
git add <file>; git commit -m "type(scope): message"  # NEVER git add . or -A; e.g. feat: add K2 camera system
```

### Linux/Mac (Unix)

```bash
git add <file> && git commit -m "type(scope): message"  # NEVER git add . or -A; e.g. feat: add K2 camera system
```

**Why this works for LLMs**: Clear, measurable, binary success/failure check. LLMs perform best with explicit "do this exact sequence" instructions.

**Why we chain with semicolon(;) and ampersand(&&)**: Other agents simultaneously might be committing, this prevents conflicts when multiple agents may be trying to add/commit to git simultaneously.

## 2. File Organization (Root Must Stay Clean)

- `docs/` – ALL .md except root `README.md`
- `scripts/` – ALL .ps1/.sh/.py/.bat
- Root only allowed: `README.md`, .sln, .csproj, .props, .gitignore, .cursor/rules

**Action**: If you see misplaced files → move them immediately → commit.

## 3. .NET Target Framework (Cross-Platform Only)

- Use ONLY: `net9.0`
- Otherwise, **Must have complementary platform support and conditional checks:**: `-windows`, `-linux`, `-macos`  e.g. `net9.0-windows` and whatever net9.0-windows equivalent is on mac/linux conditionally specified.

## 4. C# Language Version: 7.3 Maximum

**Hard limit**: C# 8+ features banned (nullable refs, switch expr, ranges, using decl, etc.)

**Rewrite pattern (if you see C# 8+)**:

- `string?` → `string` + `[CanBeNull]` (JetBrains.Annotations)
- `using var x = ...` → `using (var x = ...) { }`
- Switch expr → switch statement

### 4.1. Jetbrains.Annotations usage

- C# 7.3 doesn't support nullable reference types, so we use Jetbrains.Annotations to annotate nullable references.
- Example 1:

```csharp
[CanBeNull]
public string Name { get; set; }
```

- Example 2:

```csharp
[CanBeNull]  // may return null or a string (string? equivalent)
public string GetContent([NotNull] int index, [CanBeNull] object something = null)  // something may be null or an object
{
   // ... some logic here
}
```

## 5. Incomplete Code: ALWAYS Mark with `TODO:` + Type

```csharp
// TODO: STUB - Implement K2 event system (swkotor2.exe: 0x004eb750)
// TODO: PLACEHOLDER - Temporary GFF v3.3 (0x005ac670)
// TODO: FIXME - Memory leak in resource cache
// TODO: SIMPLIFIED - No pathfinding optimization yet
// TODO: HACK - Reflection workaround until API fixed
// TODO: STUB - A full implementation would require...
// TODO: STUB - For now, use ...
// TODO: This is a simplified...
```

**Why this works**: LLMs love searchability. `TODO:` + type + context is the gold standard for self-documenting code.

## 6. Architecture Rule – New Code vs Existing

**New code ONLY** (everything you write):
**Prefer conditional logic over inheritance**

```csharp
if (GameType == GameType.K2) { /* K2 behavior */ }
else if (GameType == GameType.K1) { /* K1 behavior */ }
```

**Existing code**: Leave inheritance alone. Never refactor it.
**Why**: LLMs get confused by "sometimes use inheritance, sometimes not". Clear rule: new = conditionals, old = keep as-is.
## 7. Reverse Engineering Workflow (Mandatory)

1. Analyze in Ghidra first
2. Document in Ghidra: rename functions/vars, add comments, prototype
3. In C#: comment source of truth

   ```csharp
   // swkotor2.exe: 0x004eb750 – original engine behavior
   if (GameType == GameType.K2) { ... }
   ```

4. Use reva mcp to ensure 1:1 parity. Setup using mcp server tool 'open-project' on project path "C:\Users\boden\Andastra Ghidra Project.gpr"

**CRUCIALLY IMPORTANT**: If reva was requested/required for the task ensure it works before proceeding with the task. If it fails or a tool call doesn't work due to a connection error or setup error or not available or something, STOP **IMMEDIATELY** and INFORM the user.

## 8. NSS/NCS Operations

Use `scripts/NcsTool.ps1` for everything (compile, decompile, compare, roundtrip, generate-defs)

## 9. Documentation

- Only public-facing .md → `docs/`
- Progress reports must be standard roadmaps that are kept in .cursor/roadmaps/*.md
- Literally all documentation should be roadmaps in ./.cursor/roadmaps or public facing in ./docs

## 10. Definition of Done (Simple Checklist)

- Code compiles (no warnings)
- Uses C# 7.3
- Matches original behavior (Ghidra-verified)
- All changes committed
- Files in correct folders
- Uses `TODO:` for anything unfinished
